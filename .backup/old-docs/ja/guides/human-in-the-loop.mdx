---
title: 人間の介入（HITL）
description: Add a human in the loop check for your agent executions
---

import { Aside, Code } from '@astrojs/starlight/components';

export const humanInTheLoopExample = `import { Agent, Runner } from '@openai/agents';

const agent = new Agent({
  model: 'gpt-4o-mini',
  instructions: '承認が必要なタスクでユーザーを支援します。',
  tools: [
    {
      type: 'function',
      function: {
        name: 'send_email',
        description: 'メール送信（人間の承認が必要）',
        parameters: {
          type: 'object',
          properties: {
            to: { type: 'string', description: '受信者のメール' },
            subject: { type: 'string', description: 'メール件名' },
            body: { type: 'string', description: 'メール本文' }
          },
          required: ['to', 'subject', 'body']
        }
      },
      needsApproval: true // このツールには人間の承認が必要
    }
  ]
});

const runner = new Runner(agent);

// ストリーミングモードで承認を処理
const stream = runner.stream('john@example.comに会議についてメールを送信してください');

for await (const event of stream) {
  if (event.type === 'human_required') {
    console.log('人間の承認が必要:', event.message);
    
    // 実際のアプリでは、これをユーザーに表示します
    const userApproval = await askUserForApproval(event);
    
    if (userApproval) {
      await event.approve();
    } else {
      await event.reject('ユーザーがメール送信を拒否しました');
    }
  } else if (event.type === 'text_delta') {
    process.stdout.write(event.data);
  }
}`;

export const toolApprovalDefinition = `import { Agent } from '@openai/agents';

const agent = new Agent({
  model: 'gpt-4o-mini',
  instructions: 'さまざまな操作を実行できます。',
  tools: [
    {
      type: 'function',
      function: {
        name: 'delete_file',
        description: 'システムからファイルを削除',
        parameters: {
          type: 'object',
          properties: {
            filename: { type: 'string', description: '削除するファイル' }
          },
          required: ['filename']
        }
      },
      // ファイル削除には常に承認が必要
      needsApproval: true
    },
    {
      type: 'function',
      function: {
        name: 'transfer_money',
        description: 'アカウント間でお金を送金',
        parameters: {
          type: 'object',
          properties: {
            from: { type: 'string', description: '送金元アカウント' },
            to: { type: 'string', description: '送金先アカウント' },
            amount: { type: 'number', description: '送金額' }
          },
          required: ['from', 'to', 'amount']
        }
      },
      // 金額に基づく条件付き承認
      needsApproval: async (context, args) => {
        return args.amount > 1000; // 大きな送金のみ承認が必要
      }
    },
    {
      type: 'function',
      function: {
        name: 'get_weather',
        description: '現在の天気を取得',
        parameters: {
          type: 'object',
          properties: {
            location: { type: 'string' }
          },
          required: ['location']
        }
      }
      // needsApprovalなし - このツールは自動実行可能
    }
  ]
});`;

このガイドでは、SDK に組み込まれた Human in the loop (人間の介入) サポートを使用して、人の介入に基づきエージェントの実行を一時停止および再開する方法を説明します。

現在の主なユースケースは、機微なツール実行に対する承認を求めることです。

## 承認リクエスト

`needsApproval` オプションを `true`、または boolean を返す async function に設定することで、承認が必要なツールを定義できます。

<Code
  lang="typescript"
  code={toolApprovalDefinition}
  title="ツール承認の定義"
  meta={`{10}`}
/>

### フロー

1. エージェントがツール（複数の場合も）を呼び出すと判断した場合、`needsApproval` を評価してそのツールに承認が必要かを確認します
2. 承認が必要な場合、すでに承認または却下されているかを確認します
   - 承認/却下がまだ行われていない場合、ツールは「ツール呼び出しを実行できない」という固定のメッセージをエージェントに返します
   - 承認 / 却下が未決の場合、ツール承認リクエストをトリガーします
3. エージェントはすべてのツール承認リクエストを収集し、実行を中断します
4. 中断がある場合、[エージェントの実行結果](/openai-agents-js/ja/guides/result) には保留中のステップを記述する `interruptions` 配列が含まれます。ツール呼び出しに確認が必要なときには、`type: "tool_approval_item"` を持つ `ToolApprovalItem` が表示されます
5. ツール呼び出しを承認または却下するには、`result.state.approve(interruption)` または `result.state.reject(interruption)` を呼び出します
6. すべての中断を処理したら、`result.state` を `runner.run(agent, state)` に渡して実行を再開できます。ここで `agent` は全体の実行をトリガーした元のエージェントです
7. フローは 1 から再開します

## 例

以下は、ターミナルで承認を求め、状態を一時的にファイルに保存する Human in the loop (人間の介入) フローの、より完全な例です。

<Code
  lang="typescript"
  code={humanInTheLoopExample}
  title="Human in the loop (人間の介入)"
/>

動作する end-to-end 版については、[完全なサンプルスクリプト](https://github.com/openai/openai-agents-js/tree/main/examples/agent-patterns/human-in-the-loop.ts) を参照してください。

## 承認に時間がかかる場合の対応

Human in the loop (人間の介入) フローは、サーバーを稼働し続けることなく長時間中断できるように設計されています。いったんリクエストを終了し、後で続行する必要がある場合は、状態をシリアライズして後から再開できます。

`JSON.stringify(result.state)` を使って状態をシリアライズし、後でシリアライズ済みの状態を `RunState.fromString(agent, serializedState)` に渡すことで再開できます。ここで `agent` は全体の実行をトリガーしたエージェントのインスタンスです。

この方法により、シリアライズした状態をデータベース、またはリクエストと一緒に保存できます。

### 保留タスクのバージョニング

<Aside>
  これは主に、エージェントに変更を加えながらシリアライズ済みの状態を長期間保存しようとしている場合に該当します
</Aside>

承認リクエストに時間がかかり、エージェント定義を意味のある形でバージョン管理したい、または Agents SDK のバージョンを上げたい場合は、現在のところ、パッケージエイリアスを使用して 2 つのバージョンの Agents SDK を並行インストールし、独自のブランチングロジックを実装することをおすすめします。

実務上は、独自コードにバージョン番号を割り当て、それをシリアライズ済みの状態と一緒に保存し、逆シリアライズを適切なコードのバージョンに誘導することを意味します。
