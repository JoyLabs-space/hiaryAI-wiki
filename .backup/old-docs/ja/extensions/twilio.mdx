---
title: Realtime Agent を Twilio に接続
description: Connect your Agents SDK agents to Twilio to use voice agents
---

import { Aside, Steps, Code } from '@astrojs/starlight/components';

export const twilioBasicExample = `import { RealtimeAgent } from '@openai/agents/realtime';
import { TwilioTransport } from '@openai/agents/extensions/twilio';

const agent = new RealtimeAgent({
  model: 'gpt-4o-realtime-preview',
  instructions: '電話通話用の親切な音声アシスタントです。簡潔で明確な応答を心がけてください。',
  voice: 'alloy',
  tools: [
    {
      type: 'function',
      function: {
        name: 'get_customer_info',
        description: 'データベースから顧客情報を取得',
        parameters: {
          type: 'object',
          properties: {
            phone_number: { type: 'string', description: '顧客の電話番号' }
          },
          required: ['phone_number']
        }
      }
    }
  ]
});

// Twilioトランスポートを設定
const transport = new TwilioTransport({
  // Twilioウェブフックがオーディオをこのエンドポイントに送信
  webhookUrl: 'https://your-server.com/twilio/webhook',
  
  // オプション: オーディオフォーマットを設定
  audioFormat: {
    encoding: 'mulaw',
    sampleRate: 8000,
    channels: 1
  },
  
  // オプション: 電話通話用の割り込み設定
  interruption: {
    threshold: 0.3, // 電話通話の遅延に対する低い閾値
    debounceMs: 300  // 電話通話用の若干長いデバウンス
  }
});

// Twilioトランスポートでセッションを作成
const session = agent.connect(transport);

// 着信Twilio通話を処理
export async function handleTwilioWebhook(request: Request) {
  const formData = await request.formData();
  const callSid = formData.get('CallSid') as string;
  
  // 着信通話を処理
  await session.handleTwilioCall({
    callSid,
    streamSid: formData.get('StreamSid') as string,
    from: formData.get('From') as string,
    to: formData.get('To') as string,
  });
  
  return new Response(
    \`<?xml version="1.0" encoding="UTF-8"?>
    <Response>
      <Connect>
        <Stream url="wss://your-server.com/twilio/stream/\${callSid}" />
      </Connect>
    </Response>\`,
    { 
      headers: { 'Content-Type': 'text/xml' }
    }
  );
}`;

export const twilioServerExample = `import express from 'express';
import { createServer } from 'http';
import { WebSocketServer } from 'ws';
import { RealtimeAgent } from '@openai/agents/realtime';
import { TwilioTransport } from '@openai/agents/extensions/twilio';

const app = express();
const server = createServer(app);
const wss = new WebSocketServer({ server });

// フォームデータ解析用のミドルウェア
app.use(express.urlencoded({ extended: true }));

// 音声エージェントを作成
const agent = new RealtimeAgent({
  model: 'gpt-4o-realtime-preview',
  instructions: \`ACME Corp.のカスタマーサービスエージェントです。
  
これは電話通話なので、応答は簡潔で専門的にしてください。
サポートが必要な場合は、発信者の名前とアカウント番号をお尋ねください。
複雑な問題は適切に人間のエージェントに転送してください。\`,
  voice: 'nova',
  tools: [
    {
      type: 'function',
      function: {
        name: 'lookup_account',
        description: '顧客アカウント情報を検索',
        parameters: {
          type: 'object',
          properties: {
            account_number: { type: 'string' },
            phone: { type: 'string' }
          }
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'transfer_to_human',
        description: '人間のエージェントに転送',
        parameters: {
          type: 'object',
          properties: {
            reason: { type: 'string', description: '転送の理由' }
          },
          required: ['reason']
        }
      }
    }
  ]
});

// 通話開始用のTwilioウェブフックを処理
app.post('/twilio/webhook', (req, res) => {
  const callSid = req.body.CallSid;
  
  console.log(\`着信通話: \${callSid}\`);
  
  const twimlResponse = \`<?xml version="1.0" encoding="UTF-8"?>
  <Response>
    <Say voice="alice">AIアシスタントに接続している間、お待ちください。</Say>
    <Connect>
      <Stream url="wss://\${req.get('host')}/twilio/stream/\${callSid}" />
    </Connect>
  </Response>\`;
  
  res.type('text/xml');
  res.send(twimlResponse);
});

// TwilioからのWebSocket接続を処理
wss.on('connection', (ws, request) => {
  const url = new URL(request.url!, \`http://\${request.headers.host}\`);
  const callSid = url.pathname.split('/').pop();
  
  console.log(\`通話用WebSocket接続: \${callSid}\`);
  
  // この通話用のTwilioトランスポートを作成
  const transport = new TwilioTransport({
    websocket: ws,
    callSid,
    audioFormat: {
      encoding: 'mulaw',
      sampleRate: 8000,
      channels: 1
    }
  });
  
  // この通話にエージェントを接続
  const session = agent.connect(transport);
  
  ws.on('close', () => {
    console.log(\`通話終了: \${callSid}\`);
    session.disconnect();
  });
  
  ws.on('error', (error) => {
    console.error(\`通話\${callSid}のWebSocketエラー:\`, error);
    session.disconnect();
  });
});

// サーバーを開始
const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
  console.log(\`Twilio音声エージェントサーバーがポート\${PORT}で実行中\`);
  console.log(\`ウェブフックURL: https://your-domain.com/twilio/webhook\`);
});`;

Twilio は [Media Streams API](https://www.twilio.com/docs/voice/media-streams) を提供しており、電話の通話からの 元 のオーディオを WebSocket サーバーに送信します。このセットアップを使って、[音声エージェントの概要](/openai-agents-js/ja/guides/voice-agents) を Twilio に接続できます。デフォルトの Realtime Session トランスポートを `websocket` モードで使い、Twilio から届くイベントを Realtime Session に接続することもできます。ただし、その場合は適切なオーディオ形式を設定し、Web ベースの会話より電話では遅延が大きくなりやすいため、割り込みのタイミングを調整する必要があります。

セットアップ体験を改善するため、Twilio への接続を扱う専用のトランスポートレイヤーを用意しました。割り込みの処理や音声の転送も含めて対応します。

<Aside type="caution">
  このアダプターはまだベータ版です。レアケースの問題やバグに遭遇する可能性があります。
  問題は [GitHub issues](https://github.com/openai/openai-agents-js/issues)
  で報告してください。迅速に修正します。
</Aside>

## セットアップ

<Steps>

1. **Twilio アカウントと Twilio の電話番号を用意していることを確認してください。**

2. **Twilio からのイベントを受信できる WebSocket サーバーをセットアップします。**

   ローカルで開発している場合、Twilio からローカルのサーバーにアクセスできるようにするため、
   [`ngrok`](https://ngrok.io/) や
   [Cloudflare Tunnel](https://developers.cloudflare.com/pages/how-to/preview-with-cloudflare-tunnel/)
   のようなローカルトンネルの設定が必要になります。このためにはローカルトンネルの設定が必要になります。`TwilioRealtimeTransportLayer`
   を使って Twilio に接続できます。

3. **extensions パッケージをインストールして Twilio アダプターを導入します:**

   ```bash
   npm install @openai/agents-extensions
   ```

4. **アダプターとモデルをインポートし、`RealtimeSession` に接続します:**

   <Code
     lang="typescript"
     code={twilioBasicExample.replace(
       /\n\s+\/\/ @ts-expect-error - this is not defined/g,
       '',
     )}
   />

5. **あなたの `RealtimeSession` を Twilio に接続します:**

   ```typescript
   session.connect({ apiKey: 'your-openai-api-key' });
   ```

</Steps>

ツール呼び出し、ガードレールなどを含め、`RealtimeSession` に期待されるあらゆるイベントや動作はそのまま機能します。`RealtimeSession` を音声エージェントで使う方法の詳細は、[音声エージェントの概要](/openai-agents-js/ja/guides/voice-agents) を参照してください。

## ヒントと考慮事項

1. **速度が最重要です。**

   Twilio から必要なイベントと音声をすべて受け取るため、WebSocket 接続の参照を得たらすぐに
   `TwilioRealtimeTransportLayer` インスタンスを作成し、直後に `session.connect()` を呼び出してください。

2. **Twilio の 元 のイベントにアクセスします。**

   Twilio から送信される 元 のイベントにアクセスしたい場合は、`RealtimeSession` インスタンスで
   `transport_event` イベントをリッスンします。Twilio からのすべてのイベントは type が
   `twilio_message` で、 元 のイベントデータを含む `message` プロパティを持ちます。

3. **デバッグログを確認します。**

   状況をより詳しく知りたい問題に遭遇することがあります。環境変数 `DEBUG=openai-agents*` を使用すると、
   Agents SDK からのすべてのデバッグログが表示されます。もしくは、
   `DEBUG=openai-agents:extensions:twilio*` を使って Twilio アダプターのデバッグログだけを有効にできます。

## 完全なサンプルサーバー

以下は、Twilio からのリクエストを受け取り、それらを `RealtimeSession` に転送する、エンドツーエンドの完全な WebSocket サーバーのサンプルの例です。

<Code
  lang="typescript"
  code={twilioServerExample}
  title="Fastify を使ったサンプルサーバー"
/>
